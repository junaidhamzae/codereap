<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CodeReap Viewer</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <header id="appHeader" style="display:none" role="banner">
      <div class="left">
        Report: <span id="reportName" aria-live="polite">None</span>
        <button id="changeReport" style="display:none" aria-label="Change report file">Change report</button>
      </div>
    </header>
    <main id="landing" class="card" role="main">
      <h1>Select a CodeReap JSON report</h1>
      <input id="fileInput" type="file" accept=".json" aria-label="Choose a JSON report file" />
    </main>
    <section id="app" style="display:none" role="main">
      <div class="view-controls">
        <div class="controls-row">
          <div class="tabs-group">
            <nav class="tabs" role="tablist">
              <button id="tabTree" class="active" role="tab" aria-selected="true" aria-controls="treePane">
                <span>Explore Tree</span>
                <span class="sr-only">Browse project structure</span>
              </button>
              <button id="tabPrune" role="tab" aria-selected="false" aria-controls="prunePane">
                <span>Prioritize Pruning</span>
                <span class="sr-only">Review orphan candidates</span>
              </button>
            </nav>
            <div class="tooltip-wrapper checkbox-wrapper">
              <input id="onlyOrphans" type="checkbox" aria-label="Show only orphaned files and directories" />
              <label for="onlyOrphans">Only orphans</label>
              <div class="tooltip" role="tooltip">Show only orphaned files/directories (no incoming dependencies). When unchecked,
                orphans are highlighted in red.</div>
              </div>
          </div>
        </div>
      </div>
      <div id="treePane" role="tabpanel" aria-labelledby="tabTree">
        <div id="treeContainer" role="tree" aria-label="Project file tree"></div>
      </div>
      <div id="prunePane" style="display:none" role="tabpanel" aria-labelledby="tabPrune">
        <div id="pruneControls" role="toolbar" aria-label="Table controls"></div>
        <table id="pruneTable" role="grid" aria-label="Files and directories to consider for pruning">
          <thead role="rowgroup">
            <tr>
              <th scope="col">Path</th>
              <th scope="col">Size</th>
              <th scope="col">In-degree</th>
              <th scope="col">Exports (Orphan/Total)</th>
            </tr>
          </thead>
          <tbody role="rowgroup"></tbody>
        </table>
      </div>
    </section>
    <script>
      function showError(title, message) {
        const landing = document.getElementById('landing');
        landing.innerHTML = `
          <h1>${title}</h1>
          <p class="error-message">${message}</p>
          <ul>
            <li>Run <code>codereap --viewer</code> to start the viewer server</li>
            <li>Use <code>--viewer --port 3000</code> to specify a port</li>
            <li>Or serve this directory over HTTP using any web server</li>
          </ul>
        `;
      }

      // Detect file:// protocol
      if (window.location.protocol === 'file:') {
        // Load bundled version for file:// protocol
        const script = document.createElement('script');
        script.src = 'app.bundle.js';
        script.onerror = () => {
          showError(
            'Error Loading Viewer',
            'The viewer cannot be loaded directly from disk due to browser security restrictions. Please use one of these options:'
          );
        };
        document.body.appendChild(script);
      } else {
        // Load ESM version for HTTP
        const script = document.createElement('script');
        script.type = 'module';
        script.src = '/app.js';
        script.onerror = () => {
          showError(
            'Error Loading Viewer',
            'Failed to load the viewer modules. This could be due to network issues or missing files. Please try:'
          );
        };
        document.body.appendChild(script);
      }

      // Global error handler for runtime errors
      window.onerror = (msg, src, line, col, error) => {
        showError(
          'Viewer Error',
          'An error occurred while running the viewer. This might be due to an incompatible browser or missing features. Error: ' + msg
        );
        return false; // Let the error propagate
      };
    </script>
  </body>
  </html>


